<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sp.app.admin.mapper.AdvertisementManageMapper">

   <sql id="where-list">
        <choose>
            <when test="schType == 'advertisingId'">
                INSTR(advertisingId, #{kwd}) &gt;= 1
            </when>
            <when test="schType == 'username'">
                INSTR(username, #{kwd}) &gt;= 1
            </when>
            <!-- 안전하지 않은 ${schType} 직접 사용 제거 -->
            <otherwise>
                INSTR(${schType}, #{kwd}) &gt;= 1
            </otherwise>
        </choose>
    </sql>
    
<!-- 광고 신청 목록 -->
	<select id="listAdvertisement" parameterType="map" resultType="com.sp.app.admin.model.AdvertisementManage">
	SELECT advertisingId, username, subject, content, TO_CHAR(regDate, 'YYYY-MM-DD') regDate, inquiryType, status,
	 postingStatus, email, tel, TO_CHAR(adverStart, 'YYYY-MM-DD') adverStart, TO_CHAR(adverEnd , 'YYYY-MM-DD') adverEnd
	 FROM advertising
	<where>
        <if test="kwd != null and kwd != ''">
            <include refid="where-list"/>
        </if>
            <choose>
                <when test="role == 2">
                    AND status = 4
                </when>
                <when test="role == 1">
                    AND status = 5
                </when>
                <when test="role == 3">
                    AND status = 3
                </when>
                <otherwise>
					AND ( status = 0 OR status = 5 )
				</otherwise>
            </choose>
    </where>
    ORDER BY regDate DESC
    OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>
	
	
	<!-- 카운트 -->
	<select id="dataCount" parameterType="map" resultType="Integer">
        SELECT COUNT(*)
        FROM advertising
        <where>
            <if test="kwd != null and kwd != ''">
                <include refid="where-list"/>
            </if>
            <choose>
                <when test="role == 2">
                    AND status = 4
                </when>
                <when test="role == 1">
                    AND status = 5
                </when>
                <when test="role == 3">
                    AND status = 3
                </when>
                <otherwise>
					AND ( status = 0 OR status = 5 )
				</otherwise>
            </choose>
        </where>
    </select>
    
    <!-- 상태 변경 -->
    <update id="updateStatus" parameterType="map">
	    UPDATE advertising
	    SET status = #{status}
	    WHERE advertisingId = #{advertisingId}
	</update>
	
	<update id="updateAdvertisement">
	    UPDATE advertising
	    SET 
	        inquiryType = #{inquiryType, jdbcType=NUMERIC},
	        postingStatus = #{postingStatus, jdbcType=NUMERIC}
	    WHERE advertisingId = #{advertisingId, jdbcType=NUMERIC}
	</update>
	
	
	<!-- 상세보기 -->
	<select id="findById" parameterType="Long" resultType="com.sp.app.admin.model.AdvertisementManage">
		SELECT advertisingId, username, subject, content, TO_CHAR(regDate, 'YYYY-MM-DD') regDate, inquiryType, status,
	 postingStatus, email, tel, TO_CHAR(adverStart, 'YYYY-MM-DD') adverStart, TO_CHAR(adverEnd , 'YYYY-MM-DD') adverEnd
	 FROM advertising
	 WHERE advertisingId = #{advertisingId}
	</select>
	
	<!-- 파일 상세보기 -->
	<select id="findByFileId" parameterType="Long" resultType="com.sp.app.admin.model.AdvertisementManage">
    SELECT advertisingFileNum, advertisingId, saveFilename, originalFilename, fileSize
    FROM advertisingFile
    WHERE advertisingFileNum = #{advertisingFileNum}
	</select>


</mapper>